---
import Layout from "../../layouts/Layout.astro";
import SEO from "../../components/SEO.astro";
import { PRODUCTS } from "../../data/products";
import ProductCard from "../../components/ProductCard.astro";
import type { Product } from "../../data/products";
import { getCurrentLanguage, getLocalizedPath, useTranslations, getProductTranslation } from "../../i18n";
import '../../styles/product.css';
import { getCategoryName, getAllImages } from '../../data/product-utils';

// Funci√≥n requerida para rutas din√°micas en Astro
export async function getStaticPaths() {
  return PRODUCTS.map((product) => ({
    params: { id: product.id.toString() },
    props: { product },
  }));
}

interface Props {
  product: Product;
}

// Obtener el producto desde props (generado por getStaticPaths)
const { product } = Astro.props;

// Detectar idioma desde URL
const currentLang = getCurrentLanguage(Astro);
const t = useTranslations(currentLang);
const getPath = (path: string) => getLocalizedPath(path, currentLang);

// Obtener traducciones del producto
const productTrans = getProductTranslation(product.id, currentLang);
const productName = productTrans?.name || product.name;
const productDescription = productTrans?.description || product.description;
const productDetailedDescription = productTrans?.detailedDescription || product.detailedDescription;
const productBadge = productTrans?.badge || product.badge;

const productImage = typeof product.image === "string" ? product.image : product.image.src;
const productUrl = `https://oro-inca-joyeria.vercel.app${getPath(`/product/${product.id}`)}`;

// Obtener productos similares (misma categor√≠a, excluyendo el producto actual) - m√°s productos
const similarProducts = PRODUCTS.filter(
  (p) => p.category === product.category && p.id !== product.id
).slice(0, 8);

const productImages = getAllImages(product);
const mainImageSrc = productImages[0];
---

<Layout>
  <SEO
    title={`${productName} | ${currentLang === 'en' ? 'ORO INCA Jewelry - Buy Online' : 'ORO INCA Joyer√≠a - Compra Online'}`}
    description={productDetailedDescription || productDescription}
    canonical={`/product/${product.id}`}
    ogImage={productImage}
    ogType="product"
    keywords={`${product.name}, ${product.category}, joyer√≠a, oro, plata, comprar online`}
    lang={currentLang}
    structuredData={{
      "@context": "https://schema.org",
      "@type": "Product",
      "name": productName,
      "description": productDetailedDescription || productDescription,
      "image": productImage,
      "brand": {
        "@type": "Brand",
        "name": "ORO INCA Joyer√≠a"
      },
      "offers": {
        "@type": "Offer",
        "url": productUrl,
        "priceCurrency": "PEN",
        "price": product.price,
        "priceValidUntil": new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        "itemCondition": "https://schema.org/NewCondition",
        "availability": "https://schema.org/InStock",
        "seller": {
          "@type": "Organization",
          "name": "ORO INCA Joyer√≠a"
        }
      },
      "category": product.category,
      ...(product.oldPrice && {
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.5",
          "reviewCount": "10"
        }
      })
    }}
  />
  <section class="pt-24 pb-16 bg-white">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Breadcrumb con nuevo dise√±o -->
      <nav class="mb-10 text-sm" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-[#16273B]/60">
          <li>
            <a href="/" class="hover:text-[#D4AF37] transition-colors duration-300 font-medium">
              Inicio
            </a>
          </li>
          <li class="text-[#16273B]/30">/</li>
          <li>
            <a href="/products" class="hover:text-[#D4AF37] transition-colors duration-300 font-medium">
              Productos
            </a>
          </li>
          <li class="text-[#16273B]/30">/</li>
          <li>
            <a 
              href={`/products?category=${product.category}#${product.category}`} 
              class="hover:text-[#D4AF37] transition-colors duration-300 font-medium"
            >
              {getCategoryName(product.category)}
            </a>
          </li>
          <li class="text-[#16273B]/30">/</li>
          <li class="text-[#16273B] font-semibold">{productName}</li>
        </ol>
      </nav>

      <!-- Producto Principal con dise√±o mejorado -->
      <div class="grid md:grid-cols-2 gap-12 lg:gap-16 mb-24">
        
        <!-- Galer√≠a de Im√°genes con dise√±o elegante -->
        <div class="space-y-4 product-gallery">
          <!-- Imagen Principal con Zoom -->
          <div class="relative overflow-hidden rounded-md shadow-xl group cursor-zoom-in bg-gradient-to-br from-gray-50 to-white" id="main-image-container">
            {productBadge && (
              <span class="absolute top-6 left-6 bg-[#D4AF37] text-white text-xs font-bold px-5 py-2.5 rounded-full z-10 shadow-lg uppercase tracking-wide">
                {productBadge}
              </span>
            )}
            <img
              id="main-product-image"
              src={mainImageSrc}
              alt={productName}
              class="w-full h-auto object-cover transition-transform duration-500 ease-out group-hover:scale-110"
            />
          </div>
          
          <!-- Miniaturas (si hay m√°s de una imagen) con dise√±o mejorado -->
          {productImages.length > 1 && (
            <div class="flex gap-3 overflow-x-auto pb-2 thumbnail-container">
              {productImages.map((imgSrc, index) => (
                <button
                  type="button"
                  class="thumbnail-btn flex-shrink-0 w-24 h-24 rounded-md overflow-hidden border-3 border-gray-200 hover:border-[#D4AF37] transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-[#D4AF37] focus:ring-offset-2 shadow-md hover:shadow-lg"
                  data-image-src={imgSrc}
                >
                  <img
                    src={imgSrc}
                    alt={`${productName} - ${currentLang === 'en' ? 'View' : 'Vista'} ${index + 1}`}
                    class="w-full h-full object-cover"
                  />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- Informaci√≥n del Producto con dise√±o elegante -->
        <div class="space-y-6 product-info">
          <div class="space-y-4">
            <span class="inline-block px-5 py-2 bg-gradient-to-r from-[#D4AF37]/10 to-[#D4AF37]/5 text-[#16273B] rounded-full text-sm font-semibold uppercase tracking-wide border border-[#D4AF37]/20">
              {getCategoryName(product.category)}
            </span>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-[#16273B] leading-tight">
              {productName}
            </h1>
            <p class="text-lg text-[#16273B]/70 leading-relaxed font-light">
              {productDescription}
            </p>
            {productDetailedDescription && (
              <div class="mt-8 pt-8 border-t border-[#D4AF37]/20">
                <h3 class="text-2xl font-semibold text-[#16273B] mb-4 flex items-center gap-2">
                  <span class="w-1 h-6 bg-[#D4AF37] rounded-full"></span>
                  {currentLang === 'en' ? 'Detailed Description' : 'Descripci√≥n Detallada'}
                </h3>
                <p class="text-[#16273B]/70 leading-relaxed">
                  {productDetailedDescription}
                </p>
              </div>
            )}
          </div>

          <!-- Precio con dise√±o destacado -->
          <div class="py-8 my-6 border-y border-[#D4AF37]/20 bg-gradient-to-r from-transparent via-[#D4AF37]/5 to-transparent">
            <div class="flex items-baseline gap-4 justify-center md:justify-start">
              <span class="text-5xl md:text-6xl font-bold text-[#D4AF37]">
                S/ {product.price.toFixed(2)}
              </span>
              {product.oldPrice && (
                <span class="text-2xl line-through text-[#16273B]/30 font-light">
                  S/ {product.oldPrice.toFixed(2)}
                </span>
              )}
            </div>
            {product.oldPrice && (
              <p class="text-sm text-green-600 mt-3 font-medium text-center md:text-left">
                ‚ú® {t('common.ahorra')} S/ {(product.oldPrice - product.price).toFixed(2)}
              </p>
            )}
          </div>

          <!-- Botones de Acci√≥n con dise√±o mejorado -->
          <div class="flex flex-col sm:flex-row gap-4">
            <a
              href={`https://wa.me/51944480535?text=${currentLang === 'en' ? 'Hello, I am interested in the product:' : 'Hola, me interesa el producto:'} ${productName} - S/ ${product.price}`}
              target="_blank"
              class="flex-1 bg-[#25D366] hover:bg-[#20BA5A] text-white px-8 py-5 rounded-md font-semibold text-center transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-0.5 flex items-center justify-center gap-2"
            >
              <span class="text-xl">üí¨</span>
              <span>{currentLang === 'en' ? 'Consult via WhatsApp' : 'Consultar por WhatsApp'}</span>
            </a>
            <a
              href={getPath("/products")}
              class="flex-1 bg-white border-2 border-[#16273B] hover:bg-[#16273B] text-[#16273B] hover:text-white px-8 py-5 rounded-md font-semibold text-center transition-all duration-300 shadow-md hover:shadow-lg hover:-translate-y-0.5"
            >
              {t('common.verMas')}
            </a>
          </div>

          <!-- Informaci√≥n Adicional con dise√±o de tarjetas -->
          <div class="pt-8 space-y-4">
            <div class="flex items-start gap-4 p-5 rounded-md bg-gradient-to-br from-[#D4AF37]/5 to-transparent border border-[#D4AF37]/10 hover:border-[#D4AF37]/30 transition-colors duration-300">
              <div class="w-12 h-12 rounded-full bg-[#D4AF37]/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-[#D4AF37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-[#16273B] text-lg">{t('common.garantiaCalidad')}</h3>
                <p class="text-[#16273B]/60 text-sm mt-1">{t('common.garantiaDescripcion')}</p>
              </div>
            </div>
            <div class="flex items-start gap-4 p-5 rounded-md bg-gradient-to-br from-[#D4AF37]/5 to-transparent border border-[#D4AF37]/10 hover:border-[#D4AF37]/30 transition-colors duration-300">
              <div class="w-12 h-12 rounded-full bg-[#D4AF37]/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-[#D4AF37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-[#16273B] text-lg">{t('common.envioNacional')}</h3>
                <p class="text-[#16273B]/60 text-sm mt-1">{t('common.envioDescripcion')}</p>
              </div>
            </div>
            <div class="flex items-start gap-4 p-5 rounded-md bg-gradient-to-br from-[#D4AF37]/5 to-transparent border border-[#D4AF37]/10 hover:border-[#D4AF37]/30 transition-colors duration-300">
              <div class="w-12 h-12 rounded-full bg-[#D4AF37]/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-[#D4AF37]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-[#16273B] text-lg">{t('common.pagoSeguro')}</h3>
                <p class="text-[#16273B]/60 text-sm mt-1">{t('common.pagoDescripcion')}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Productos Similares / Recomendaciones -->
      {similarProducts.length > 0 && (
        <div class="mb-24">
          <div class="text-center mb-12">
            <h2 class="text-4xl md:text-5xl font-bold text-[#16273B] mb-4">
              {t('common.productosRecomendados')}
            </h2>
            <div class="w-24 h-1 bg-gradient-to-r from-transparent via-[#D4AF37] to-transparent mx-auto"></div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {similarProducts.map((similarProduct) => {
              const similarTrans = getProductTranslation(similarProduct.id, currentLang);
              return (
                <ProductCard
                  id={similarProduct.id}
                  name={similarTrans?.name || similarProduct.name}
                  description={similarTrans?.description || similarProduct.description}
                  price={similarProduct.price}
                  oldPrice={similarProduct.oldPrice}
                  image={similarProduct.image}
                  badge={similarTrans?.badge || similarProduct.badge}
                />
              );
            })}
          </div>
        </div>
      )}

      <!-- Secci√≥n de Contacto con dise√±o renovado -->
      <div class="bg-gradient-to-br from-[#16273B] to-[#16273B]/90 rounded-md p-8 md:p-12 mb-20 shadow-2xl relative overflow-hidden">
        <!-- Patr√≥n decorativo de fondo -->
        <div class="absolute inset-0 opacity-5">
          <div class="absolute top-0 left-0 w-64 h-64 bg-[#D4AF37] rounded-full blur-3xl"></div>
          <div class="absolute bottom-0 right-0 w-96 h-96 bg-[#D4AF37] rounded-full blur-3xl"></div>
        </div>
        
        <div class="max-w-4xl mx-auto text-center relative z-10">
          <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
            ¬øTienes alguna pregunta?
          </h2>
          <p class="text-lg text-white/80 mb-10 font-light">
            Estamos aqu√≠ para ayudarte. Cont√°ctanos y te responderemos lo antes posible.
          </p>
          
          <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- WhatsApp -->
            <a
              href="https://wa.me/51944480535"
              target="_blank"
              class="bg-white p-8 rounded-md shadow-lg hover:shadow-2xl transition-all duration-300 group hover:-translate-y-1"
            >
              <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">üí¨</div>
              <h3 class="font-semibold text-xl text-[#16273B] mb-2">WhatsApp</h3>
              <p class="text-[#16273B]/60 text-sm mb-4 font-medium">+51 926 946 362</p>
              <span class="text-[#25D366] font-semibold group-hover:text-[#20BA5A] inline-flex items-center gap-2">
                Enviar mensaje
                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </span>
            </a>

            <!-- Tel√©fono -->
            <div class="bg-white p-8 rounded-md shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
              <div class="text-5xl mb-4">üìû</div>
              <h3 class="font-semibold text-xl text-[#16273B] mb-2">Tel√©fono</h3>
              <p class="text-[#16273B]/60 text-sm mb-4 font-medium">+51 926 946 362</p>
              <a href="tel:+51944480535" class="text-[#D4AF37] font-semibold hover:text-[#b8941f] inline-flex items-center gap-2">
                Llamar ahora
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </a>
            </div>
          </div>

          <!-- Informaci√≥n Adicional -->
          <div class="bg-white/95 backdrop-blur-sm p-8 rounded-md shadow-lg">
            <h3 class="font-semibold text-xl text-[#16273B] mb-6">Informaci√≥n de Contacto</h3>
            <div class="grid sm:grid-cols-2 gap-6 text-left">
              <div class="flex items-start gap-3">
                <span class="text-2xl">üìç</span>
                <div>
                  <p class="text-sm text-[#16273B]/60 font-medium uppercase tracking-wide mb-1">Ubicaci√≥n</p>
                  <p class="font-semibold text-[#16273B] text-lg">Per√∫</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <span class="text-2xl">‚è∞</span>
                <div>
                  <p class="text-sm text-[#16273B]/60 font-medium uppercase tracking-wide mb-1">Horario de Atenci√≥n</p>
                  <p class="font-semibold text-[#16273B] text-lg">Lun - S√°b: 9:00 AM - 8:00 PM</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</Layout>

<script type="module">
  import { initProductGallery } from '../../js/product-gallery.js';
  initProductGallery();
</script>