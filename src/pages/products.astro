---
import Layout from "../layouts/Layout.astro";
import SEO from "../components/SEO.astro";
import { PRODUCTS } from "../data/products";
import ProductCard from "../components/ProductCard.astro";
import { type Language } from "../i18n";

const category = Astro.url.searchParams.get("category");

// Detectar idioma desde URL
import { getCurrentLanguage, getBasePath, useTranslations, getProductTranslation } from "../i18n";
const currentLang = getCurrentLanguage(Astro);
const t = useTranslations(currentLang);

// Calcular rangos de precio
const prices = PRODUCTS.map(p => p.price);
const minPrice = Math.floor(Math.min(...prices));
const maxPrice = Math.ceil(Math.max(...prices));

// Obtener todas las categor√≠as √∫nicas
const allCategories = Array.from(new Set(PRODUCTS.map(p => p.category)));

// T√≠tulos y descripciones seg√∫n categor√≠a
const categoryNames: Record<string, { es: string; en: string }> = {
  anillos: { es: "Anillos de Oro y Plata", en: "Gold and Silver Rings" },
  aretes: { es: "Aretes de Oro y Plata", en: "Gold and Silver Earrings" },
  collares: { es: "Collares de Oro y Plata", en: "Gold and Silver Necklaces" },
  pulseras: { es: "Pulseras de Oro y Plata", en: "Gold and Silver Bracelets" },
};

const categoryTitle = category && categoryNames[category] 
  ? (currentLang === 'en' ? categoryNames[category].en : categoryNames[category].es)
  : (currentLang === 'en' ? "Our Products" : "Nuestros Productos");

const pageTitle = currentLang === 'en' 
  ? `${categoryTitle} | ORO INCA Jewelry - Buy Online`
  : `${categoryTitle} | ORO INCA Joyer√≠a - Compra Online`;

const pageDescription = category
  ? (currentLang === 'en'
      ? `Discover our collection of ${categoryTitle.toLowerCase()}. High quality jewelry with national shipping.`
      : `Descubre nuestra colecci√≥n de ${categoryTitle.toLowerCase()}. Joyas de alta calidad con env√≠o nacional.`)
  : (currentLang === 'en'
      ? "Discover our complete collection of gold and silver jewelry. Rings, earrings, necklaces and bracelets with national shipping."
      : "Descubre nuestra colecci√≥n completa de joyas de oro y plata. Anillos, aretes, collares y pulseras con env√≠o nacional.");
---

<Layout>
  <SEO
    title={pageTitle}
    description={pageDescription}
    canonical={`/products${category ? `?category=${category}` : ''}`}
    keywords={category 
      ? `joyer√≠a ${category}, ${category} oro, ${category} plata, comprar ${category} online`
      : "joyer√≠a Per√∫, joyas de oro, joyas de plata, anillos, aretes, collares, pulseras, joyer√≠a online"}
    lang={currentLang}
    structuredData={{
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": categoryTitle,
      "description": pageDescription,
      "url": `https://oro-inca-joyeria.vercel.app/products${category ? `?category=${category}` : ''}`,
      "mainEntity": {
        "@type": "ItemList",
        "numberOfItems": PRODUCTS.length,
        "itemListElement": PRODUCTS.slice(0, 10).map((product, index) => ({
          "@type": "ListItem",
          "position": index + 1,
          "item": {
            "@type": "Product",
            "name": product.name,
            "description": product.description,
            "image": typeof product.image === "string" ? product.image : product.image.src,
            "offers": {
              "@type": "Offer",
              "price": product.price,
              "priceCurrency": "PEN",
              "availability": "https://schema.org/InStock"
            }
          }
        }))
      }
    }}
  />
  <section class="pt-24 pb-24 bg-white">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header mejorado -->
      <div class="mb-12 products-header">
        <div class="inline-block mb-4">
          <span class="px-6 py-2 bg-gradient-to-r from-[#D4AF37]/10 to-[#D4AF37]/5 text-[#16273B] rounded-full text-sm font-semibold uppercase tracking-wider border border-[#D4AF37]/20">
            {currentLang === 'en' ? 'Our Collection' : 'Nuestra Colecci√≥n'}
          </span>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-[#16273B] mb-4 leading-tight">
          {categoryTitle}
        </h1>
        <div class="w-24 h-1 bg-gradient-to-r from-transparent via-[#D4AF37] to-transparent mb-6"></div>
        <p class="text-[#16273B]/70 text-xl font-light max-w-2xl">
          {t('products.subtitulo')}
        </p>
      </div>

      <!-- Bot√≥n para abrir filtros en m√≥vil con dise√±o mejorado -->
      <div class="lg:hidden mb-6 flex items-center justify-between gap-4">
        <button
          id="filters-toggle"
          class="flex items-center gap-3 bg-white border-2 border-[#16273B] hover:bg-[#16273B] hover:text-white rounded-md px-6 py-3 text-sm font-semibold text-[#16273B] transition-all duration-300 shadow-md hover:shadow-lg"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
          {t('common.filtrar')}
        </button>
        <div class="text-sm font-medium text-[#16273B]">
          <span id="mobile-results-count" class="text-[#D4AF37] text-lg font-bold">{PRODUCTS.length}</span> {t('common.productos')}
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-8">
        
        <!-- Sidebar de Filtros mejorado -->
        <aside class="lg:w-80 flex-shrink-0">
          <!-- Desktop: Sidebar normal -->
          <div class="hidden lg:block bg-gradient-to-br from-white to-gray-50 rounded-md shadow-xl p-8 sticky top-24 border border-gray-100">
            
            <h2 class="text-2xl font-bold text-[#16273B] mb-8 flex items-center gap-3">
              <span class="w-1.5 h-8 bg-[#D4AF37] rounded-full"></span>
              {t('common.filtrar')}
            </h2>

            <!-- B√∫squeda con dise√±o mejorado -->
            <div class="mb-8">
              <label for="search-input" class="block text-sm font-bold text-[#16273B] mb-3 uppercase tracking-wide">
                {t('products.buscarProductos')}
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="search-input"
                  placeholder={t('products.buscarPorNombre')}
                  class="w-full px-5 py-4 pl-12 border-2 border-gray-200 rounded-md focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all duration-300 text-[#16273B] placeholder-[#16273B]/40"
                />
                <svg class="w-5 h-5 text-[#16273B]/40 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>

            <!-- Categor√≠as con dise√±o mejorado -->
            <div class="mb-8">
              <h3 class="text-lg font-bold text-[#16273B] mb-4 flex items-center gap-2">
                <span class="text-[#D4AF37]">‚óÜ</span>
                {t('products.categorias')}
              </h3>
              <div class="space-y-3">
                <label class="flex items-center cursor-pointer group">
                  <input
                    type="checkbox"
                    class="category-filter w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0 transition-all"
                    value=""
                    checked
                  />
                  <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('common.todas')}</span>
                </label>
                {allCategories.map((cat) => {
                  const catName = currentLang === 'en' 
                    ? (cat === 'anillos' ? 'Rings' : cat === 'aretes' ? 'Earrings' : cat === 'collares' ? 'Necklaces' : cat === 'pulseras' ? 'Bracelets' : cat)
                    : (cat === 'anillos' ? 'Anillos' : cat === 'aretes' ? 'Aretes' : cat === 'collares' ? 'Collares' : cat === 'pulseras' ? 'Pulseras' : cat);
                  return (
                    <label class="flex items-center cursor-pointer group">
                      <input
                        type="checkbox"
                        class="category-filter w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0 transition-all"
                        value={cat}
                      />
                      <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{catName}</span>
                    </label>
                  );
                })}
              </div>
            </div>

            <!-- Rango de Precio con dise√±o mejorado -->
            <div class="mb-8">
              <h3 class="text-lg font-bold text-[#16273B] mb-4 flex items-center gap-2">
                <span class="text-[#D4AF37]">‚óÜ</span>
                {t('products.rangoPrecio')}
              </h3>
              <div class="space-y-4">
                <div class="flex gap-3">
                  <input
                    type="number"
                    id="min-price"
                    placeholder={currentLang === 'en' ? 'Min' : 'M√≠n'}
                    min={minPrice}
                    max={maxPrice}
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-md focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all text-[#16273B]"
                  />
                  <input
                    type="number"
                    id="max-price"
                    placeholder={currentLang === 'en' ? 'Max' : 'M√°x'}
                    min={minPrice}
                    max={maxPrice}
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-md focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all text-[#16273B]"
                  />
                </div>
                <div class="text-sm text-[#16273B]/60 font-medium text-center bg-[#D4AF37]/5 py-2 rounded-md">
                  S/ {minPrice} - S/ {maxPrice}
                </div>
              </div>
            </div>

            <!-- Filtros Especiales con dise√±o mejorado -->
            <div class="mb-8">
              <h3 class="text-lg font-bold text-[#16273B] mb-4 flex items-center gap-2">
                <span class="text-[#D4AF37]">‚óÜ</span>
                {t('products.caracteristicas')}
              </h3>
              <div class="space-y-3">
                <label class="flex items-center cursor-pointer group">
                  <input
                    type="checkbox"
                    id="filter-ofertas"
                        class="special-filter w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0 transition-all"
                    data-filter="oferta"
                  />
                  <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('products.enOferta')}</span>
                </label>
                <label class="flex items-center cursor-pointer group">
                  <input
                    type="checkbox"
                    id="filter-nuevos"
                        class="special-filter w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0 transition-all"
                    data-filter="nuevo"
                  />
                  <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('products.nuevos')}</span>
                </label>
                <label class="flex items-center cursor-pointer group">
                  <input
                    type="checkbox"
                    id="filter-descuentos"
                        class="special-filter w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0 transition-all"
                    data-filter="descuento"
                  />
                  <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('products.conDescuento')}</span>
                </label>
              </div>
            </div>

            <!-- Bot√≥n Limpiar Filtros mejorado -->
            <button
              id="clear-filters"
              class="w-full bg-white border-2 border-[#16273B] hover:bg-[#16273B] hover:text-white text-[#16273B] px-6 py-4 rounded-md font-bold transition-all duration-300 shadow-md hover:shadow-lg"
            >
              {t('common.limpiarFiltros')}
            </button>

            <!-- Contador de resultados mejorado -->
            <div class="mt-8 pt-8 border-t-2 border-[#D4AF37]/20">
              <div class="text-center bg-gradient-to-r from-[#D4AF37]/10 to-transparent p-4 rounded-md">
                <p class="text-sm text-[#16273B]/70 font-medium">
                  {t('common.mostrar')}
                </p>
                <p class="text-3xl font-bold text-[#D4AF37] mt-1">
                  <span id="results-count">{PRODUCTS.length}</span>
                </p>
                <p class="text-sm text-[#16273B]/70 font-medium">
                  {t('common.productos')}
                </p>
              </div>
            </div>

          </div>

          <!-- Mobile: Drawer de filtros mejorado -->
          <div
            id="filters-drawer"
            class="lg:hidden fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out"
          >
            <!-- Overlay oscuro -->
            <div
              id="filters-overlay"
              class="absolute inset-0 bg-[#16273B]/60 backdrop-blur-sm"
            ></div>

            <!-- Drawer -->
            <div class="absolute right-0 top-0 h-full w-full max-w-sm bg-white shadow-2xl overflow-y-auto">
              <div class="p-6">
                <!-- Header del drawer mejorado -->
                <div class="flex items-center justify-between mb-8 pb-6 border-b-2 border-[#D4AF37]/20">
                  <h2 class="text-2xl font-bold text-[#16273B] flex items-center gap-3">
                    <span class="w-1.5 h-8 bg-[#D4AF37] rounded-full"></span>
                    {t('common.filtrar')}
                  </h2>
                  <button
                    id="close-filters"
                    class="text-[#16273B] hover:text-[#D4AF37] transition-colors p-2"
                    aria-label={currentLang === 'en' ? 'Close filters' : 'Cerrar filtros'}
                  >
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                
                <!-- Contenido de filtros (mismo estilo que desktop) -->
                <!-- B√∫squeda -->
                <div class="mb-8">
                  <label for="search-input-mobile" class="block text-sm font-bold text-[#16273B] mb-3 uppercase tracking-wide">
                    {t('products.buscarProductos')}
                  </label>
                  <div class="relative">
                    <input
                      type="text"
                      id="search-input-mobile"
                      placeholder={t('products.buscarPorNombre')}
                      class="w-full px-5 py-4 pl-12 border-2 border-gray-200 rounded-md focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all duration-300 text-[#16273B] placeholder-[#16273B]/40"
                    />
                    <svg class="w-5 h-5 text-[#16273B]/40 absolute left-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                  </div>
                </div>

                <!-- Categor√≠as -->
                <div class="mb-8">
                  <h3 class="text-lg font-bold text-[#16273B] mb-4 flex items-center gap-2">
                    <span class="text-[#D4AF37]">‚óÜ</span>
                    {t('products.categorias')}
                  </h3>
                  <div class="space-y-3">
                    <label class="flex items-center cursor-pointer group">
                      <input
                        type="checkbox"
                        class="category-filter-mobile w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0"
                        value=""
                        checked
                      />
                      <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('common.todas')}</span>
                    </label>
                    {allCategories.map((cat) => {
                      const catName = currentLang === 'en' 
                        ? (cat === 'anillos' ? 'Rings' : cat === 'aretes' ? 'Earrings' : cat === 'collares' ? 'Necklaces' : cat === 'pulseras' ? 'Bracelets' : cat)
                        : (cat === 'anillos' ? 'Anillos' : cat === 'aretes' ? 'Aretes' : cat === 'collares' ? 'Collares' : cat === 'pulseras' ? 'Pulseras' : cat);
                      return (
                        <label class="flex items-center cursor-pointer group">
                          <input
                            type="checkbox"
                            class="category-filter-mobile w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0"
                            value={cat}
                          />
                          <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{catName}</span>
                        </label>
                      );
                    })}
                  </div>
                </div>

                <!-- Rango de Precio -->
                <div class="mb-8">
                  <h3 class="text-lg font-bold text-[#16273B] mb-4 flex items-center gap-2">
                    <span class="text-[#D4AF37]">‚óÜ</span>
                    {t('products.rangoPrecio')}
                  </h3>
                  <div class="space-y-4">
                    <div class="flex gap-3">
                      <input
                        type="number"
                        id="min-price-mobile"
                        placeholder={currentLang === 'en' ? 'Min' : 'M√≠n'}
                        min={minPrice}
                        max={maxPrice}
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-md focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all text-[#16273B]"
                      />
                      <input
                        type="number"
                        id="max-price-mobile"
                        placeholder={currentLang === 'en' ? 'Max' : 'M√°x'}
                        min={minPrice}
                        max={maxPrice}
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-md focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all text-[#16273B]"
                      />
                    </div>
                    <div class="text-sm text-[#16273B]/60 font-medium text-center bg-[#D4AF37]/5 py-2 rounded-md">
                      S/ {minPrice} - S/ {maxPrice}
                    </div>
                  </div>
                </div>

                <!-- Filtros Especiales -->
                <div class="mb-8">
                  <h3 class="text-lg font-bold text-[#16273B] mb-4 flex items-center gap-2">
                    <span class="text-[#D4AF37]">‚óÜ</span>
                    {t('products.caracteristicas')}
                  </h3>
                  <div class="space-y-3">
                    <label class="flex items-center cursor-pointer group">
                      <input
                        type="checkbox"
                        id="filter-ofertas-mobile"
                        class="special-filter-mobile w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0"
                        data-filter="oferta"
                      />
                      <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('products.enOferta')}</span>
                    </label>
                    <label class="flex items-center cursor-pointer group">
                      <input
                        type="checkbox"
                        id="filter-nuevos-mobile"
                        class="special-filter-mobile w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0"
                        data-filter="nuevo"
                      />
                      <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('products.nuevos')}</span>
                    </label>
                    <label class="flex items-center cursor-pointer group">
                      <input
                        type="checkbox"
                        id="filter-descuentos-mobile"
                        class="special-filter-mobile w-5 h-5 rounded-md border-2 border-gray-300 text-[#D4AF37] focus:ring-[#D4AF37] focus:ring-offset-0"
                        data-filter="descuento"
                      />
                      <span class="ml-3 text-[#16273B] font-medium group-hover:text-[#D4AF37] transition-colors">{t('products.conDescuento')}</span>
                    </label>
                  </div>
                </div>

                <!-- Bot√≥n Limpiar Filtros -->
                <button
                  id="clear-filters-mobile"
                  class="w-full bg-white border-2 border-[#16273B] hover:bg-[#16273B] hover:text-white text-[#16273B] px-6 py-4 rounded-md font-bold transition-all duration-300 shadow-md hover:shadow-lg"
                >
                  {t('common.limpiarFiltros')}
                </button>
              </div>
            </div>
          </div>
        </aside>

        <!-- √Årea Principal de Productos -->
        <div class="flex-1">
          
          <!-- Ordenamiento mejorado -->
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 p-6 bg-gradient-to-r from-gray-50 to-white rounded-2xl border border-gray-100">
            <div class="flex items-center gap-4">
              <span class="text-sm font-semibold text-[#16273B] uppercase tracking-wide">{t('products.ordenarPor')}</span>
              <select
                id="sort-select"
                class="px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-[#D4AF37] focus:border-[#D4AF37] outline-none transition-all font-medium text-[#16273B]"
              >
                <option value="default">{t('products.porDefecto')}</option>
                <option value="price-asc">{t('products.precioMenorMayor')}</option>
                <option value="price-desc">{t('products.precioMayorMenor')}</option>
                <option value="name-asc">{t('products.nombreAZ')}</option>
                <option value="name-desc">{t('products.nombreZA')}</option>
              </select>
            </div>
          </div>

          <!-- Grid de Productos -->
          <div
            id="products-grid"
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            {PRODUCTS.map((product) => {
              const imageSrc = typeof product.image === "string" ? product.image : product.image.src;
              return (
                <div
                  class="product-item"
                  data-product-id={product.id}
                  data-name={product.name.toLowerCase()}
                  data-category={product.category}
                  data-price={product.price}
                  data-has-discount={product.oldPrice ? "true" : "false"}
                  data-badge={product.badge || ""}
                >
                  <ProductCard
                    id={product.id}
                    name={getProductTranslation(product.id, currentLang)?.name || product.name}
                    description={getProductTranslation(product.id, currentLang)?.description || product.description}
                    price={product.price}
                    oldPrice={product.oldPrice}
                    image={product.image}
                    badge={getProductTranslation(product.id, currentLang)?.badge || product.badge}
                  />
                </div>
              );
            })}
          </div>

          <!-- Mensaje cuando no hay resultados mejorado -->
          <div id="no-results" class="hidden text-center py-20">
            <div class="max-w-md mx-auto">
              <div class="text-7xl mb-6">üîç</div>
              <h3 class="text-2xl font-bold text-[#16273B] mb-4">
                {t('common.noResultados')}
              </h3>
              <p class="text-[#16273B]/70 text-lg mb-6">
                {t('common.ajustarFiltros')}
              </p>
              <button
                id="reset-all-filters"
                class="bg-[#D4AF37] hover:bg-[#b8941f] text-white px-8 py-4 rounded-2xl font-bold transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-0.5"
              >
                {t('common.limpiarFiltros')}
              </button>
            </div>
          </div>

        </div>

      </div>

    </div>
  </section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const categoryFilters = document.querySelectorAll('.category-filter') as NodeListOf<HTMLInputElement>;
    const specialFilters = document.querySelectorAll('.special-filter') as NodeListOf<HTMLInputElement>;
    const minPriceInput = document.getElementById('min-price') as HTMLInputElement;
    const maxPriceInput = document.getElementById('max-price') as HTMLInputElement;
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const clearFiltersBtn = document.getElementById('clear-filters') as HTMLButtonElement;
    const productsGrid = document.getElementById('products-grid') as HTMLElement;
    const noResults = document.getElementById('no-results') as HTMLElement;
    const resultsCount = document.getElementById('results-count') as HTMLElement;
    const resetAllFiltersBtn = document.getElementById('reset-all-filters') as HTMLButtonElement;

    const productItems = Array.from(document.querySelectorAll('.product-item'));

    function filterProducts() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      // Obtener categor√≠as seleccionadas
      const selectedCategories = Array.from(categoryFilters)
        .filter(cb => cb.checked && cb.value !== '')
        .map(cb => cb.value);
      const showAllCategories = Array.from(categoryFilters).find(cb => cb.value === '' && cb.checked);

      // Obtener filtros especiales
      const showOfertas = (document.getElementById('filter-ofertas') as HTMLInputElement)?.checked || false;
      const showNuevos = (document.getElementById('filter-nuevos') as HTMLInputElement)?.checked || false;
      const showDescuentos = (document.getElementById('filter-descuentos') as HTMLInputElement)?.checked || false;

      // Obtener rango de precios
      const minPrice = minPriceInput.value ? parseFloat(minPriceInput.value) : null;
      const maxPrice = maxPriceInput.value ? parseFloat(maxPriceInput.value) : null;

      let visibleItems = productItems.filter(item => {
        const name = item.getAttribute('data-name') || '';
        const category = item.getAttribute('data-category') || '';
        const price = parseFloat(item.getAttribute('data-price') || '0');
        const badge = item.getAttribute('data-badge') || '';
        const hasDiscount = item.getAttribute('data-has-discount') === 'true';

        // Filtro de b√∫squeda
        if (searchTerm && !name.includes(searchTerm)) {
          return false;
        }

        // Filtro de categor√≠as
        if (!showAllCategories && selectedCategories.length > 0 && !selectedCategories.includes(category)) {
          return false;
        }

        // Filtro de rango de precios
        if (minPrice !== null && price < minPrice) {
          return false;
        }
        if (maxPrice !== null && price > maxPrice) {
          return false;
        }

        // Filtros especiales
        if (showOfertas && badge !== 'Oferta') {
          return false;
        }
        if (showNuevos && badge !== 'Nuevo') {
          return false;
        }
        if (showDescuentos && !hasDiscount) {
          return false;
        }

        return true;
      });

      // Ordenar productos
      const sortValue = sortSelect.value;
      visibleItems.sort((a, b) => {
        if (sortValue === 'price-asc') {
          const priceA = parseFloat(a.getAttribute('data-price') || '0');
          const priceB = parseFloat(b.getAttribute('data-price') || '0');
          return priceA - priceB;
        } else if (sortValue === 'price-desc') {
          const priceA = parseFloat(a.getAttribute('data-price') || '0');
          const priceB = parseFloat(b.getAttribute('data-price') || '0');
          return priceB - priceA;
        } else if (sortValue === 'name-asc') {
          const nameA = a.getAttribute('data-name') || '';
          const nameB = b.getAttribute('data-name') || '';
          return nameA.localeCompare(nameB);
        } else if (sortValue === 'name-desc') {
          const nameA = a.getAttribute('data-name') || '';
          const nameB = b.getAttribute('data-name') || '';
          return nameB.localeCompare(nameA);
        }
        return 0;
      });

      // Ocultar todos los productos
      productItems.forEach(item => {
        (item as HTMLElement).style.display = 'none';
      });

      // Mostrar productos filtrados
      visibleItems.forEach(item => {
        (item as HTMLElement).style.display = 'block';
      });

      // Actualizar contador
      resultsCount.textContent = visibleItems.length.toString();
      const mobileResultsCount = document.getElementById('mobile-results-count');
      if (mobileResultsCount) {
        mobileResultsCount.textContent = visibleItems.length.toString();
      }

      // Mostrar/ocultar mensaje de no resultados
      if (visibleItems.length === 0) {
        noResults.classList.remove('hidden');
        productsGrid.classList.add('hidden');
      } else {
        noResults.classList.add('hidden');
        productsGrid.classList.remove('hidden');
      }

      // Reorganizar el DOM para reflejar el orden
      visibleItems.forEach(item => {
        productsGrid.appendChild(item);
      });
    }

    function clearAllFilters() {
      searchInput.value = '';
      categoryFilters.forEach(cb => {
        if (cb.value === '') {
          cb.checked = true;
        } else {
          cb.checked = false;
        }
      });
      specialFilters.forEach(cb => cb.checked = false);
      minPriceInput.value = '';
      maxPriceInput.value = '';
      sortSelect.value = 'default';
      filterProducts();
    }

    // Event listeners
    searchInput.addEventListener('input', filterProducts);
    categoryFilters.forEach(cb => cb.addEventListener('change', filterProducts));
    specialFilters.forEach(cb => cb.addEventListener('change', filterProducts));
    minPriceInput.addEventListener('input', filterProducts);
    maxPriceInput.addEventListener('input', filterProducts);
    sortSelect.addEventListener('change', filterProducts);

    // Limpiar filtros
    clearFiltersBtn.addEventListener('click', clearAllFilters);
    resetAllFiltersBtn?.addEventListener('click', clearAllFilters);

    // Si hay una categor√≠a en la URL, aplicar el filtro
    const urlCategory = new URLSearchParams(window.location.search).get('category');
    if (urlCategory) {
      categoryFilters.forEach(cb => {
        if (cb.value === urlCategory) {
          cb.checked = true;
          // Desmarcar "Todas"
          const allCategoriesCheckbox = Array.from(categoryFilters).find(c => c.value === '');
          if (allCategoriesCheckbox) {
            allCategoriesCheckbox.checked = false;
          }
        }
      });
      filterProducts();
    }

    // ========== FUNCIONALIDAD M√ìVIL ==========
    const filtersDrawer = document.getElementById('filters-drawer');
    const filtersToggle = document.getElementById('filters-toggle');
    const closeFilters = document.getElementById('close-filters');
    const filtersOverlay = document.getElementById('filters-overlay');
    const searchInputMobile = document.getElementById('search-input-mobile') as HTMLInputElement;
    const categoryFiltersMobile = document.querySelectorAll('.category-filter-mobile') as NodeListOf<HTMLInputElement>;
    const specialFiltersMobile = document.querySelectorAll('.special-filter-mobile') as NodeListOf<HTMLInputElement>;
    const minPriceInputMobile = document.getElementById('min-price-mobile') as HTMLInputElement;
    const maxPriceInputMobile = document.getElementById('max-price-mobile') as HTMLInputElement;
    const clearFiltersBtnMobile = document.getElementById('clear-filters-mobile') as HTMLButtonElement;

    // Funci√≥n para abrir drawer
    function openFiltersDrawer() {
      if (filtersDrawer) {
        filtersDrawer.classList.remove('translate-x-full');
        document.body.style.overflow = 'hidden';
      }
    }

    // Funci√≥n para cerrar drawer
    function closeFiltersDrawer() {
      if (filtersDrawer) {
        filtersDrawer.classList.add('translate-x-full');
        document.body.style.overflow = '';
      }
    }

    // Event listeners para drawer
    filtersToggle?.addEventListener('click', openFiltersDrawer);
    closeFilters?.addEventListener('click', closeFiltersDrawer);
    filtersOverlay?.addEventListener('click', closeFiltersDrawer);

    // Funci√≥n de filtrado m√≥vil (sincroniza con desktop)
    function syncMobileFilters() {
      // Sincronizar b√∫squeda
      if (searchInputMobile && searchInput) {
        searchInputMobile.value = searchInput.value;
      }
      
      // Sincronizar categor√≠as
      categoryFiltersMobile.forEach(mobileCb => {
        const desktopCb = Array.from(categoryFilters).find(dc => dc.value === mobileCb.value);
        if (desktopCb) {
          mobileCb.checked = desktopCb.checked;
        }
      });
      
      // Sincronizar precios
      if (minPriceInputMobile && minPriceInput) {
        minPriceInputMobile.value = minPriceInput.value;
      }
      if (maxPriceInputMobile && maxPriceInput) {
        maxPriceInputMobile.value = maxPriceInput.value;
      }
      
      // Sincronizar filtros especiales
      specialFiltersMobile.forEach(mobileCb => {
        const filterType = mobileCb.getAttribute('data-filter');
        const desktopCb = Array.from(specialFilters).find(dc => dc.getAttribute('data-filter') === filterType);
        if (desktopCb) {
          mobileCb.checked = desktopCb.checked;
        }
      });
    }

    // Sincronizar filtros m√≥viles con desktop
    function syncDesktopFilters() {
      // Sincronizar b√∫squeda
      if (searchInputMobile && searchInput) {
        searchInput.value = searchInputMobile.value;
      }
      
      // Sincronizar categor√≠as
      categoryFiltersMobile.forEach(mobileCb => {
        const desktopCb = Array.from(categoryFilters).find(dc => dc.value === mobileCb.value);
        if (desktopCb) {
          desktopCb.checked = mobileCb.checked;
        }
      });
      
      // Sincronizar precios
      if (minPriceInputMobile && minPriceInput) {
        minPriceInput.value = minPriceInputMobile.value;
      }
      if (maxPriceInputMobile && maxPriceInput) {
        maxPriceInput.value = maxPriceInputMobile.value;
      }
      
      // Sincronizar filtros especiales
      specialFiltersMobile.forEach(mobileCb => {
        const filterType = mobileCb.getAttribute('data-filter');
        const desktopCb = Array.from(specialFilters).find(dc => dc.getAttribute('data-filter') === filterType);
        if (desktopCb) {
          desktopCb.checked = mobileCb.checked;
        }
      });
    }

    // Event listeners m√≥viles
    searchInputMobile?.addEventListener('input', () => {
      syncDesktopFilters();
      filterProducts();
    });
    
    categoryFiltersMobile.forEach(cb => {
      cb.addEventListener('change', () => {
        syncDesktopFilters();
        filterProducts();
      });
    });
    
    specialFiltersMobile.forEach(cb => {
      cb.addEventListener('change', () => {
        syncDesktopFilters();
        filterProducts();
      });
    });
    
    minPriceInputMobile?.addEventListener('input', () => {
      syncDesktopFilters();
      filterProducts();
    });
    
    maxPriceInputMobile?.addEventListener('input', () => {
      syncDesktopFilters();
      filterProducts();
    });

    // Limpiar filtros m√≥vil
    clearFiltersBtnMobile?.addEventListener('click', () => {
      if (searchInputMobile) searchInputMobile.value = '';
      categoryFiltersMobile.forEach(cb => {
        if (cb.value === '') {
          cb.checked = true;
        } else {
          cb.checked = false;
        }
      });
      specialFiltersMobile.forEach(cb => cb.checked = false);
      if (minPriceInputMobile) minPriceInputMobile.value = '';
      if (maxPriceInputMobile) maxPriceInputMobile.value = '';
      syncDesktopFilters();
      filterProducts();
    });

    // Sincronizar al abrir drawer
    filtersToggle?.addEventListener('click', () => {
      setTimeout(syncMobileFilters, 100);
    });
  });
</script>

<style>
  .product-item {
    display: block;
    animation: fadeInUp 0.4s ease-out both;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .products-header {
    animation: fadeInDown 0.6s ease-out;
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilo para checkboxes personalizados */
  input[type="checkbox"]:checked {
    background-color: #D4AF37;
    border-color: #D4AF37;
  }

  /* Transici√≥n suave para el drawer */
  #filters-drawer {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>